#!/bin/bash

set -e

outputdir=$PWD
if [[ "$1" == '-o' ]]; then
	outputdir="$2"
	shift 2
fi

while [[ -n "$1" ]]; do
	file=$1
	tmp="$(mktemp -d)"
	fullpath=$(realpath "$file")
	inputname=$(basename "$file")
	pdfname="${inputname%.cb?}.pdf"
	pdf="$outputdir/$pdfname"

	if [[ -z "$file" ]] || [[ ! "$file" =~ \.cb(r|z)$ ]]; then
		echo "$file might not be a comic (not a .cbr or .cbz file)"
		exit 1
	fi

	if [[ ! -s "$file" ]]; then
		echo "$file is empty or does not exist"
		exit 1
	fi

	echo "=== Converting to pdf: $file === "
	echo "unzipping to: $tmp"
	if [[ "$file" =~ .\cbr ]]; then
		# TODO: 7z not working with rar files?
		(cd "$tmp" && unrar e "$fullpath" >/dev/null)
	else
		7z e -o"$tmp" "$file" >/dev/null
	fi
	echo "compiling jpg files into: $pdf"
	img2pdf -o "$pdf" "$tmp"/*.jp*g
	echo "done"

	rm -rf "$tmp"

	shift
done
